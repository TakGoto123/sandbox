<style>
  ul, li, .meal-group, .meal-group li {
    list-style: none;
    padding-left: 0;
    margin: 0;
  }

  li::marker {
    content: none;
  }

  .date-header {
    display: flex;
    background-color: #ddd;
    padding: 10px;
    font-weight: bold;
    border-top: 1px solid #aaa;
    font-size: 1.5rem;
  }

  .meal-item {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    padding: 10px;
    background: #f9f9f9;
    border-bottom: 1px solid #ccc;
    cursor: grab;
    font-size: 0.95rem;
  }

  .drag-handle {
    margin-right: 10px;
    cursor: move;
    flex: 0 0 auto;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    width: 60px;
    height: 60px;
    line-height: 1.5;
    user-select: none;
    color: #666;
  }

  .col-name,
  .col-amount,
  .col-checkbox,

  .col-name {
    flex: 1 1 100%;
    font-weight: bold;
    font-size: 1.3rem;
  }

  .col-amount {
    flex: 1 1 60%;
    text-align: left;
    color: #555;
  }

  .col-checkbox {
    flex: 0 0 40px;
    text-align: center;
  }

  @media (min-width: 600px) {
    .meal-item {
      flex-wrap: nowrap;
    }
    .col-name {
      flex: 2 1 150px;
    }
    .col-amount {
      flex: 1 1 100px;
      font-size: 0.8rem;
      font-weight: normal;
      text-align: right;
      margin-right: 5px;
    }
  }

  .delete-meal-btn {
    font-size: 1.7rem;     /* â† ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚µã‚¤ã‚º */
    padding: 4px 8px;      /* â† ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã„å¤§ãã•ã« */
    background: none;      /* èƒŒæ™¯ãªã—ï¼ˆã¾ãŸã¯å¿…è¦ã«å¿œã˜ã¦è¨­å®šï¼‰ */
    border: none;
    cursor: pointer;
    color: #444;           /* è‰²èª¿æ•´ï¼ˆä»»æ„ï¼‰ */
    line-height: 1;
  }

</style>

<script>
/**
 * çŒ®ç«‹è¡¨ç¤ºã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
 * ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã•ã‚ŒãŸJavaScriptã‚¯ãƒ©ã‚¹
 */
class MealPlanApp {
  constructor(headers, data, config) {
    this.headers = headers;
    this.raw_meal_plan = data;
    this.structured_meal_plan = {};
    this.raw_meal_plan.forEach(([date, type, menu, url, memo, id]) => {
      this.structured_meal_plan[id] = { id, date, type, menu, url, memo };
    });
    this.local_meal_plan = {};
    this.deleted_meal = {};
    this.config = config;
    
    // è¨­å®šã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if (!this.config) {
      this.config = {
        SHEET_NAME: 'menu-schedule',
        MEAL_TYPES: ['æ˜¼', 'å¤œ'],
        DATE_FORMAT: 'yyyy-MM-dd',
        TIMEZONE: 'Asia/Tokyo',
        WEEK_START_DAY: 6,
        WORK_DAYS: [2, 3, 4, 5, 6]
      };
    }
    
    // ç¾åœ¨ã®é€±ã®é–‹å§‹æ—¥ã‚’è¨­å®šï¼ˆå…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½¿ç”¨ï¼‰
    this.currentWeekStart = WeekManager.getCurrentWeekStart();
    
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã¨åŒæœŸ
    appState.setCurrentWeekStart(this.currentWeekStart);
    
    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
    this.logDebugInfo();
  }

  /**
   * ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
   */
  logDebugInfo() {
    console.log('=== çŒ®ç«‹ã‚¢ãƒ—ãƒªåˆæœŸåŒ– ===');
    console.log('Headers:', this.headers);
    console.log('Data count:', this.raw_meal_plan ? this.raw_meal_plan.length : 0);
    console.log('Config:', this.config);
    console.log('Current week start:', this.currentWeekStart);
  }

  /**
   * é€±ã‚’å¤‰æ›´
   * @param {number} offset - é€±ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆ-1: å‰é€±, 1: æ¬¡é€±ï¼‰
   */
  changeWeek(offset) {
    this.currentWeekStart = WeekManager.calculateNewWeekStart(this.currentWeekStart, offset);
    appState.setCurrentWeekStart(this.currentWeekStart);
    this.renderTable();
  }

  /**
   * é€±ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†
   * @param {Array<string>} weekDates - é€±ã®æ—¥ä»˜é…åˆ—
   * @returns {Object} æ•´ç†ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
   */
  organizeWeekData(weekDates) {
    const mealTypes = this.config?.MEAL_TYPES || ['æ˜¼', 'å¤œ'];
    const weekData = {};
    
    // åˆæœŸåŒ–
    weekDates.forEach(date => {
      weekData[date] = {};
      mealTypes.forEach(type => {
        weekData[date][type] = [];
      });
    });

    // ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†é¡
    const merged_data = {...this.structured_meal_plan, ...this.local_meal_plan};
    if (Object.keys(merged_data).length > 0) {
      for (const {id, date, type, menu, url, memo} of Object.values(merged_data)) {
        let dateRaw = date;
      
        // æ—¥ä»˜ã®æ­£è¦åŒ–å‡¦ç†ã‚’æ”¹å–„
        let dateStr = formatDate(date, "YYYY-MM-DD");
        if (weekData[dateStr] && mealTypes.includes(type) && !(this.deleted_meal[id])) {
          weekData[dateStr][type].push({ id, menu, url, memo });
        }
      }
    }

    return weekData;
  }

  renderSortableMealPlan(weekDates, weekData, container) {
    const root = container;
    root.innerHTML = "";
    Object.keys(weekData).forEach(date => {
      Object.keys(weekData[date]).forEach(type => {
        const header = document.createElement("li");
        const label = formatDate(date, "M/D(ddd)") + ` - ${type}`;
        // header.innerHTML = `<div class="date-header">${label}</div>`;
        header.innerHTML = `<div class="date-header">${label} <button class="add-meal-btn" onclick="openAddMealModal('${date}', '${type}')" title="çŒ®ç«‹ã‚’è¿½åŠ ">+</button></div>`;
        const ul = document.createElement("ul");
        ul.className = "meal-group";
        ul.dataset.date = date;
        ul.dataset.type = type;
        for (const item of weekData[date][type]) {
          const li = document.createElement("li");
          li.className = "meal-item";
          li.dataset.id = item.id;
          const menuHTML = item.url ? `<a href="${item.url}" target="_blank">${item.menu}</a>` : item.menu;
          li.innerHTML = `
            <span class="drag-handle">â˜°</span>
            <div class="col-name">${menuHTML}</div>
            <div class="col-amount">${item.memo}</div>
            <div class="action-cell">
              <button class="delete-meal-btn" onclick="handleDeleteButtonPushed('${item.id}')" title="å‰Šé™¤">
                ğŸ—‘ï¸
              </button>
            </div>
          `;
          ul.appendChild(li);
        }
        header.appendChild(ul);
        root.appendChild(header);
      });
    });
    this.enableSorting();
  }

  enableSorting() {
    document.querySelectorAll('.meal-group').forEach(group => {
      new Sortable(group, {
        animation: 150,
        handle: '.drag-handle',
        group: 'meals',
        filter: 'a, input',
        onFilter: evt => {},
        onEnd: evt => {
          // ä¸¦ã³æ›¿ãˆå…ƒã¨å…ˆã® <ul class="meal-group"> è¦ç´ ã‹ã‚‰ data å±æ€§ã‚’å–å¾—
          const fromGroup = evt.from;
          const toGroup = evt.to;

          const fromDate = fromGroup.dataset.date;
          const toDate = toGroup.dataset.date;
          const fromType = fromGroup.dataset.type;
          const toType = toGroup.dataset.type;

          const movedItem = evt.item;
          const id = movedItem.dataset.id;
          const menuName = movedItem.querySelector('.col-name')?.textContent.trim();

          console.log(`ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€Œ${menuName}ã€ï¼ˆid=${id}ï¼‰ãŒç§»å‹•ã—ã¾ã—ãŸ`);
          console.log(`  - ç§»å‹•å…ƒ: ${fromDate} ${fromType}`);
          console.log(`  - ç§»å‹•å…ˆ: ${toDate} ${toType}`);
          console.log(`  - oldIndex: ${evt.oldIndex}, newIndex: ${evt.newIndex}`);

          const newOrder = Array.from(toGroup.children).map(li => li.dataset.id);
          console.log(`æ—¥ä»˜ ${toDate} ã®æ–°ã—ã„é †ç•ª:`, newOrder);

          if (!(id in this.local_meal_plan)) {
            this.local_meal_plan[id] = this.structured_meal_plan[id];
          }
          this.local_meal_plan[id].date = toDate;
          this.local_meal_plan[id].type = toType;
          google.script.run
            .withSuccessHandler(result => {
              if (result.success == false) {
                console.error('ä¸¦ã³æ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚' + result.message);
                UIUtils.showError('ä¸¦ã³æ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚' + result.message);
              }
            })
            .withFailureHandler(error => {
              console.error('ä¸¦ã³æ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚' + error.message);
              UIUtils.showError('ä¸¦ã³æ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚' + error.message);
            })
            .updateMealMenuForApp(this.local_meal_plan[id]);
        }
      });
    });
  }
  /**
   * ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
   */
  renderTable() {
    try {
      console.log('=== ãƒ†ãƒ¼ãƒ–ãƒ«æç”»é–‹å§‹ ===');
      console.log('Current week start:', this.currentWeekStart);
      
      const weekDates = WeekManager.getWeekDates(this.currentWeekStart, this.config?.WORK_DAYS);
      console.log('Week dates:', weekDates);
      
      // é€±è¡¨ç¤ºã‚’æ›´æ–°
      const weekDisplayElement = document.getElementById('weekDisplay');
      if (weekDisplayElement) {
        weekDisplayElement.textContent = WeekManager.formatWeekDisplay(weekDates);
      }

      // ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†
      const weekData = this.organizeWeekData(weekDates);
      console.log('Organized data:', weekData);

      // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
      const tableElement = document.getElementById('mealTable');
      if (tableElement) {
        this.renderSortableMealPlan(weekDates, weekData, tableElement);
      }

      console.log('=== ãƒ†ãƒ¼ãƒ–ãƒ«æç”»å®Œäº† ===');
    } catch (error) {
      console.error('Table render error:', error);
      UIUtils.showError('ãƒ†ãƒ¼ãƒ–ãƒ«ã®æç”»ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'mealTable');
    }
  }

  /**
   * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–
   */
  initialize() {
    console.log('=== çŒ®ç«‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ– ===');
    this.renderTable();
  }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å®£è¨€
let mealPlanAppInstance = null;

/**
 * çŒ®ç«‹ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º
 */
function showMealPlan() {
  console.log('Switching to meal plan page');
  appState.setCurrentPage('meal');
  
  // ã‚¿ãƒ–ã®çŠ¶æ…‹ã‚’æ›´æ–°
  document.getElementById('mealTab').classList.add('active');
  document.getElementById('weekendTab').classList.remove('active');
  const todoTab = document.getElementById('todoTab');
  if (todoTab) {
    todoTab.classList.remove('active');
  }
  
  // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
  document.getElementById('pageTitle').textContent = 'çŒ®ç«‹ä¸€è¦§';
  
  // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
  document.getElementById('mealContent').style.display = 'block';
  document.getElementById('weekendContent').style.display = 'none';
  const todoContent = document.getElementById('todoContent');
  if (todoContent) {
    todoContent.style.display = 'none';
  }
  
  // è²·ã„å‡ºã—ãƒªã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
  const shoppingSection = document.getElementById('shoppingListSection');
  if (shoppingSection) {
    shoppingSection.style.display = 'block';
  }
  
  // çŒ®ç«‹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»
  if (mealPlanAppInstance) {
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã¨åŒæœŸ
    mealPlanAppInstance.currentWeekStart = appState.getCurrentWeekStart();
    mealPlanAppInstance.renderTable();
  }
}

/**
 * çŒ®ç«‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–
 * @param {Array} headers - ãƒ˜ãƒƒãƒ€ãƒ¼é…åˆ—
 * @param {Array} data - ãƒ‡ãƒ¼ã‚¿é…åˆ—
 * @param {Object} config - è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function initializeMealPlanApp(headers, data, config) {
  try {
    console.log('Initializing MealPlanApp...');
    mealPlanAppInstance = new MealPlanApp(headers, data, config);
    mealPlanAppInstance.initialize();
    console.log('MealPlanApp initialized successfully');
    return mealPlanAppInstance;
  } catch (error) {
    console.error('Failed to initialize MealPlanApp:', error);
    UIUtils.showError('çŒ®ç«‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'mealTable');
    return null;
  }
}

/**
 * è²·ã„å‡ºã—ãƒªã‚¹ãƒˆä½œæˆ
 */
function createShoppingList() {
  // ç¾åœ¨è¡¨ç¤ºä¸­ã®é€±ã®æ—¥ä»˜ã‚’å–å¾—
  const weekDates = WeekManager.getWeekDates(mealPlanAppInstance.currentWeekStart, mealPlanAppInstance.config?.WORK_DAYS);
  const startDate = weekDates[0]; // æ—¢ã«æ–‡å­—åˆ—å½¢å¼ï¼ˆyyyy-MM-ddï¼‰
  const endDate = weekDates[weekDates.length - 1]; // æ—¢ã«æ–‡å­—åˆ—å½¢å¼ï¼ˆyyyy-MM-ddï¼‰
  
  // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
  const confirmed = confirm(
    'è²·ã„å‡ºã—ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚\n\n' +
    `å¯¾è±¡æœŸé–“: ${startDate} ï½ ${endDate}\n` +
    'ãƒ»å‡¦ç†ã«ã¯æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™\n' +
    'ãƒ»æ—¢å­˜ã®è²·ã„å‡ºã—ãƒªã‚¹ãƒˆã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™\n\n' +
    'ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ'
  );
  
  if (!confirmed) {
    return;
  }
  
  // å‡¦ç†çŠ¶æ…‹ã‚’è¡¨ç¤º
  showProcessingState();
  
  // ã‚µãƒ¼ãƒãƒ¼é–¢æ•°ã‚’å‘¼ã³å‡ºã—ï¼ˆForAppã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ãï¼‰
  google.script.run
    .withSuccessHandler(onShoppingListCreated)
    .withFailureHandler(onShoppingListError)
    .createShoppingListForPeriodForApp(startDate, endDate);
}

/**
 * è²·ã„å‡ºã—ãƒªã‚¹ãƒˆä½œæˆæˆåŠŸæ™‚ã®å‡¦ç†
 * @param {Object} result - ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®çµæœ
 */
function onShoppingListCreated(result) {
  hideProcessingState();
  
  if (result.success) {
    const message = `${result.message}\n\n` +
                    `å¯¾è±¡æœŸé–“: ${result.period}\n` +
                    `ã‚·ãƒ¼ãƒˆå: ${result.sheetName}\n\n` +
                    'Weekendã‚¿ãƒ–ã§ç¢ºèªã—ã¾ã™ã‹ï¼Ÿ';
    
    if (confirm(message)) {
      // Weekendã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
      showWeekend();
    }
  } else {
    alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
  }
}

/**
 * è²·ã„å‡ºã—ãƒªã‚¹ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
 * @param {Object} error - ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function onShoppingListError(error) {
  hideProcessingState();
  console.error('Shopping list creation error:', error);
  alert('è²·ã„å‡ºã—ãƒªã‚¹ãƒˆä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' + error.message);
}

/**
 * å‡¦ç†ä¸­çŠ¶æ…‹ã‚’è¡¨ç¤º
 */
function showProcessingState() {
  const btn = document.getElementById('createShoppingListBtn');
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = 'â³ ä½œæˆä¸­... (æ•°åˆ†ãŠå¾…ã¡ãã ã•ã„)';
    btn.classList.add('processing');
  }
}

/**
 * å‡¦ç†ä¸­çŠ¶æ…‹ã‚’éè¡¨ç¤º
 */
function hideProcessingState() {
  const btn = document.getElementById('createShoppingListBtn');
  if (btn) {
    btn.disabled = false;
    btn.innerHTML = 'ğŸ›’ è²·ã„å‡ºã—ãƒªã‚¹ãƒˆã‚’ä½œæˆ';
    btn.classList.remove('processing');
  }
}


function handleDeleteButtonPushed(id) {
  if (modalHandlerInstance) {
    let deleteTarget = {};
    if (id in mealPlanAppInstance.local_meal_plan) {
      deleteTarget = mealPlanAppInstance.local_meal_plan[id];
    } else if (id in mealPlanAppInstance.structured_meal_plan) {
      deleteTarget = mealPlanAppInstance.structured_meal_plan[id]
    } else {
      throw new Error("Cannot find delete target");
    }
    modalHandlerInstance.openDeleteModal(deleteTarget);
  } else {
    console.error('ModalHandler instance not found');
  }
}



console.log('Meal plan module loaded successfully');
</script>
