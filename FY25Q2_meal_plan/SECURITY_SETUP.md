# 家族向けセキュア共有設定ガイド

## 概要

献立管理システムに家族向けのアクセス制限機能を実装しました。これにより、許可された家族のGoogleアカウントのみがアプリケーションにアクセスできるようになります。

## 実装内容

### 1. セキュリティ機能

- **アクセス制御**: 許可された家族のメールアドレスのみアクセス可能
- **認証**: Googleアカウントでのログインが必須
- **実行権限**: スクリプト作成者の権限で実行（データの安全性確保）
- **エラーハンドリング**: 不正アクセス時の適切なエラーページ表示

### 2. 変更されたファイル

- `appsscript.json`: Webアプリの実行設定を変更
- `code.js`: アクセス制御機能を追加

## 設定手順

### Step 1: 家族のメールアドレスを設定

`code.js`の`ALLOWED_USERS`配列に、アクセスを許可する家族のGoogleアカウントのメールアドレスを設定してください。

```javascript
const ALLOWED_USERS = [
  'family1@gmail.com',    // 家族メンバー1
  'family2@gmail.com',    // 家族メンバー2
  'family3@gmail.com'     // 家族メンバー3
  // 必要に応じて追加してください
];
```

**重要**: 実際の家族のメールアドレスに変更してください。

### Step 2: Google Apps Scriptでの設定

1. **Google Apps Script エディタを開く**
2. **ファイルをアップロード/更新**
   - `appsscript.json`
   - `code.js`
3. **Webアプリとして再デプロイ**
   - 「デプロイ」→「新しいデプロイ」
   - 種類: Webアプリ
   - **実行ユーザー: アプリにアクセスするユーザー** ← 重要！
   - アクセスできるユーザー: 全員

**重要**: 実行ユーザーは「アプリにアクセスするユーザー」に設定してください。これにより、各ユーザーの情報を正しく取得できます。

### Step 3: Google Sheetsの共有設定

1. **スプレッドシートを開く**
2. **共有設定を変更**
   - 右上の「共有」ボタンをクリック
   - 家族のGoogleアカウントを追加
   - 権限を「閲覧者」または「編集者」に設定
   - 「リンクを知っている全員」は無効化

## 動作確認

### 許可されたユーザーの場合
- 通常通りアプリケーションにアクセス可能
- 献立データの閲覧・操作が可能

### 許可されていないユーザーの場合
- アクセス拒否ページが表示される
- 「家族専用です」というメッセージ
- 管理者への問い合わせ案内

## テスト方法

### 1. アクセス制御のテスト

Google Apps Script エディタで以下の関数を実行：

```javascript
testAccessControl()
```

### 2. 実際のアクセステスト

1. **許可されたアカウントでテスト**
   - 設定したメールアドレスでGoogleにログイン
   - WebアプリのURLにアクセス
   - 正常に献立アプリが表示されることを確認

2. **許可されていないアカウントでテスト**
   - 別のGoogleアカウントでログイン
   - WebアプリのURLにアクセス
   - アクセス拒否ページが表示されることを確認

## セキュリティレベル

### 保護される内容
✅ 献立データへの不正アクセス防止  
✅ 家族以外のユーザーからの保護  
✅ Google Sheetsデータの安全性確保  
✅ スクリプト作成者の権限で実行（データ改ざん防止）

### アクセス方法
- 家族メンバーは通常のGoogleアカウントでログイン
- 追加の認証手続きは不要
- シンプルで使いやすい

## 管理・メンテナンス

### 家族メンバーの追加・削除

1. `code.js`の`ALLOWED_USERS`配列を編集
2. Google Apps Scriptで保存
3. 必要に応じてWebアプリを再デプロイ

### ログの確認

Google Apps Script エディタの「実行数」タブで以下を確認できます：
- アクセスログ
- エラーログ
- 認証状況

## トラブルシューティング

### よくある問題

1. **「ユーザー情報を取得できませんでした」エラー**
   - Googleアカウントでログインしているか確認
   - ブラウザのCookieを確認

2. **「アクセスが許可されていません」エラー**
   - `ALLOWED_USERS`にメールアドレスが正しく設定されているか確認
   - 大文字小文字の違いに注意

3. **アプリが表示されない**
   - Webアプリが正しくデプロイされているか確認
   - URLが正しいか確認

### デバッグ方法

Google Apps Script エディタで以下の関数を実行してデバッグ：

```javascript
// 現在のユーザー情報を確認
Logger.log(Session.getActiveUser().getEmail());

// アクセス制御のテスト
testAccessControl();
```

## 注意事項

- メールアドレスは大文字小文字を区別します
- Googleアカウントでのログインが必須です
- スプレッドシートの共有設定も忘れずに行ってください
- 定期的にアクセスログを確認することをお勧めします

---

**更新日**: 2025年7月12日  
**バージョン**: 1.0.0 (セキュリティ機能追加版)
